<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="jakarta.faces.html"
    xmlns:ui="jakarta.faces.facelets"
    xmlns:f="jakarta.faces.core"
    xmlns:pt="jakarta.faces.passthrough"
    template="template.xhtml">

    <ui:define name="title">Dashboard Overview</ui:define>

    <!-- Chart.js -->
    <ui:define name="head">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </ui:define>

    <ui:define name="content">

        <div class="relative max-w-[1400px] mx-auto px-4 md:px-6 lg:px-8 space-y-7">

            <h:form id="dashForm" prependId="false">

                <!-- soft glow -->
                <div class="pointer-events-none absolute -inset-x-10 -top-10 h-56
                            bg-[radial-gradient(ellipse_at_top,rgba(212,175,55,0.14),transparent_60%)]
                            blur-2xl"></div>

                <!-- HERO (AJAX RERENDER) -->
                <h:panelGroup id="heroPanel" layout="block">
                    <section class="relative overflow-hidden rounded-3xl border border-slate-100 bg-white/85 backdrop-blur shadow-xl shadow-slate-200/60">
                        <div class="p-6 md:p-7">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-5">

                                <div class="min-w-0">
                                    <p class="text-[11px] font-semibold tracking-[0.20em] uppercase text-slate-400">
                                        FeastLink overview
                                    </p>

                                    <!-- Title -->
                                    <h1 class="mt-1 text-2xl md:text-3xl font-semibold text-slate-900 truncate">

                                        <!-- MONTH -->
                                        <ui:fragment rendered="#{dashboardBean.periodMode eq 'MONTH'}">
                                            1 month:
                                            #{dashboardBean.selectedMonth eq 1 ? 'January' :
                                              dashboardBean.selectedMonth eq 2 ? 'February' :
                                              dashboardBean.selectedMonth eq 3 ? 'March' :
                                              dashboardBean.selectedMonth eq 4 ? 'April' :
                                              dashboardBean.selectedMonth eq 5 ? 'May' :
                                              dashboardBean.selectedMonth eq 6 ? 'June' :
                                              dashboardBean.selectedMonth eq 7 ? 'July' :
                                              dashboardBean.selectedMonth eq 8 ? 'August' :
                                              dashboardBean.selectedMonth eq 9 ? 'September' :
                                              dashboardBean.selectedMonth eq 10 ? 'October' :
                                              dashboardBean.selectedMonth eq 11 ? 'November' :
                                              'December'}
                                            #{dashboardBean.selectedYear}
                                        </ui:fragment>

                                        <!-- DAY -->
                                        <ui:fragment rendered="#{dashboardBean.periodMode eq 'DAY'}">
                                            1 day:
                                            <h:outputText value="#{dashboardBean.selectedDay}">
                                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                                            </h:outputText>
                                        </ui:fragment>

                                        <!-- YEAR -->
                                        <ui:fragment rendered="#{dashboardBean.periodMode eq 'YEAR'}">
                                            Year: #{dashboardBean.selectedYear}
                                        </ui:fragment>

                                        <!-- RANGE -->
                                        <ui:fragment rendered="#{dashboardBean.periodMode eq 'RANGE'}">
                                            Range:
                                            <h:outputText value="#{dashboardBean.rangeFrom}">
                                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                                            </h:outputText>
                                            →
                                            <h:outputText value="#{dashboardBean.rangeTo}">
                                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                                            </h:outputText>
                                        </ui:fragment>

                                    </h1>

                                    <p class="mt-2 text-sm text-slate-500">
                                        Track KPIs and charts for the selected time period.
                                    </p>

                                    <!-- quick badges -->
                                    <div class="mt-4 flex flex-wrap gap-2">
                                        <span class="inline-flex items-center gap-2 rounded-2xl bg-slate-50 px-3 py-1.5 text-xs font-semibold text-slate-700 border border-slate-100">
                                            <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                                            Live metrics
                                        </span>

                                        <span class="inline-flex items-center gap-2 rounded-2xl bg-slate-50 px-3 py-1.5 text-xs font-semibold text-slate-700 border border-slate-100">
                                            Bookings: #{dashboardBean.totalBookings}
                                        </span>

                                        <span class="inline-flex items-center gap-2 rounded-2xl bg-slate-50 px-3 py-1.5 text-xs font-semibold text-slate-700 border border-slate-100">
                                            Revenue: #{dashboardBean.formattedMonthlyRevenue}
                                        </span>
                                    </div>
                                </div>

                                <!-- system badge -->
                                <div class="flex md:justify-end">
                                    <span class="inline-flex items-center gap-2 rounded-2xl bg-white px-4 py-2 text-xs font-semibold text-slate-700 border border-slate-100 shadow">
                                        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                                        System healthy
                                    </span>
                                </div>

                            </div>
                        </div>
                    </section>
                </h:panelGroup>

<!-- FILTER BAR (NOTE TOP + MONTH/MODE/YEAR ONE ROW) -->
<section class="relative overflow-hidden rounded-3xl border border-slate-100 bg-white/90 shadow-xl shadow-slate-200/70">
    <div class="p-5 md:p-6 space-y-5">

        <!-- TOP ROW: NOTE (LEFT) + VIEWING (RIGHT) -->
        <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
            <div>
                <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">
                    Analytics filters
                </p>
                <p class="mt-1 text-sm text-slate-500">
                    Choose a day, month, year, or a custom date range.
                </p>
            </div>

            <div class="lg:text-right">
                <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">
                    Viewing
                </p>

                <div class="mt-2 inline-flex justify-center rounded-2xl border border-slate-100 bg-slate-50 px-4 py-3
                            text-sm font-semibold text-slate-900 min-w-[220px]">
                    <h:panelGroup id="appliedLabel" layout="inline">

                        <ui:fragment rendered="#{dashboardBean.periodMode eq 'MONTH'}">
                            1 month:
                            #{dashboardBean.selectedMonth eq 1 ? 'January' :
                              dashboardBean.selectedMonth eq 2 ? 'February' :
                              dashboardBean.selectedMonth eq 3 ? 'March' :
                              dashboardBean.selectedMonth eq 4 ? 'April' :
                              dashboardBean.selectedMonth eq 5 ? 'May' :
                              dashboardBean.selectedMonth eq 6 ? 'June' :
                              dashboardBean.selectedMonth eq 7 ? 'July' :
                              dashboardBean.selectedMonth eq 8 ? 'August' :
                              dashboardBean.selectedMonth eq 9 ? 'September' :
                              dashboardBean.selectedMonth eq 10 ? 'October' :
                              dashboardBean.selectedMonth eq 11 ? 'November' :
                              'December'}
                            #{dashboardBean.selectedYear}
                        </ui:fragment>

                        <ui:fragment rendered="#{dashboardBean.periodMode eq 'DAY'}">
                            1 day:
                            <h:outputText value="#{dashboardBean.selectedDay}">
                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                            </h:outputText>
                        </ui:fragment>

                        <ui:fragment rendered="#{dashboardBean.periodMode eq 'YEAR'}">
                            Year: #{dashboardBean.selectedYear}
                        </ui:fragment>

                        <ui:fragment rendered="#{dashboardBean.periodMode eq 'RANGE'}">
                            Range:
                            <h:outputText value="#{dashboardBean.rangeFrom}">
                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                            </h:outputText>
                            →
                            <h:outputText value="#{dashboardBean.rangeTo}">
                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                            </h:outputText>
                        </ui:fragment>

                    </h:panelGroup>
                </div>
            </div>
        </div>

        <!-- BOTTOM ROW: PRIMARY (MONTH/DATE/...) + MODE + YEAR + APPLY (ONE ROW) -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-end">

            <!-- PRIMARY FIELD (MONTH / DATE / YEAR / RANGE) -->
            <h:panelGroup id="primaryField"
                          layout="block"
                          styleClass="#{dashboardBean.periodMode eq 'RANGE' ? 'lg:col-span-6' : 'lg:col-span-4'}">

                <!-- MONTH -->
                <ui:fragment rendered="#{dashboardBean.periodMode eq 'MONTH'}">
                    <div class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Month</div>
                    <h:selectOneMenu value="#{dashboardBean.selectedMonth}"
                                     styleClass="mt-2 w-full h-12 rounded-2xl border border-slate-200 bg-white px-4 text-sm
                                                focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300">
                        <f:selectItem itemValue="1"  itemLabel="January" />
                        <f:selectItem itemValue="2"  itemLabel="February" />
                        <f:selectItem itemValue="3"  itemLabel="March" />
                        <f:selectItem itemValue="4"  itemLabel="April" />
                        <f:selectItem itemValue="5"  itemLabel="May" />
                        <f:selectItem itemValue="6"  itemLabel="June" />
                        <f:selectItem itemValue="7"  itemLabel="July" />
                        <f:selectItem itemValue="8"  itemLabel="August" />
                        <f:selectItem itemValue="9"  itemLabel="September" />
                        <f:selectItem itemValue="10" itemLabel="October" />
                        <f:selectItem itemValue="11" itemLabel="November" />
                        <f:selectItem itemValue="12" itemLabel="December" />

                        <f:ajax event="change"
                                listener="#{dashboardBean.applyFilter}"
                                render="heroPanel dashPanel appliedLabel"
                                onevent="dashAjaxEvent"/>
                    </h:selectOneMenu>
                </ui:fragment>

                <!-- DAY -->
                <ui:fragment rendered="#{dashboardBean.periodMode eq 'DAY'}">
                    <div class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Date</div>
                    <h:inputText value="#{dashboardBean.selectedDay}" pt:type="date"
                                 styleClass="mt-2 w-full h-12 rounded-2xl border border-slate-200 bg-white px-4 text-sm
                                            focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300">
                        <f:convertDateTime pattern="yyyy-MM-dd"/>
                        <f:ajax event="change"
                                listener="#{dashboardBean.applyFilter}"
                                render="heroPanel dashPanel appliedLabel"
                                onevent="dashAjaxEvent"/>
                    </h:inputText>
                </ui:fragment>

                <!-- YEAR (when mode=YEAR, year is the primary field) -->
                <ui:fragment rendered="#{dashboardBean.periodMode eq 'YEAR'}">
                    <div class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Year</div>
                    <h:selectOneMenu value="#{dashboardBean.selectedYear}"
                                     styleClass="mt-2 w-full h-12 rounded-2xl border border-slate-200 bg-white px-4 text-sm
                                                focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300">
                        <f:selectItems value="#{dashboardBean.yearOptions}"/>
                        <f:ajax event="change"
                                listener="#{dashboardBean.applyFilter}"
                                render="heroPanel dashPanel appliedLabel"
                                onevent="dashAjaxEvent"/>
                    </h:selectOneMenu>
                </ui:fragment>

                <!-- RANGE -->
                <ui:fragment rendered="#{dashboardBean.periodMode eq 'RANGE'}">
                    <div class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Range</div>
                    <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <div class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">From</div>
                            <h:inputText value="#{dashboardBean.rangeFrom}" pt:type="date"
                                         styleClass="mt-2 w-full h-12 rounded-2xl border border-slate-200 bg-white px-4 text-sm
                                                    focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300">
                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                                <f:ajax event="change"
                                        listener="#{dashboardBean.applyFilter}"
                                        render="heroPanel dashPanel appliedLabel"
                                        onevent="dashAjaxEvent"/>
                            </h:inputText>
                        </div>
                        <div>
                            <div class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">To</div>
                            <h:inputText value="#{dashboardBean.rangeTo}" pt:type="date"
                                         styleClass="mt-2 w-full h-12 rounded-2xl border border-slate-200 bg-white px-4 text-sm
                                                    focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300">
                                <f:convertDateTime pattern="yyyy-MM-dd"/>
                                <f:ajax event="change"
                                        listener="#{dashboardBean.applyFilter}"
                                        render="heroPanel dashPanel appliedLabel"
                                        onevent="dashAjaxEvent"/>
                            </h:inputText>
                        </div>
                    </div>
                </ui:fragment>

            </h:panelGroup>

            <!-- MODE -->
            <h:panelGroup id="modeField"
                          layout="block"
                          styleClass="#{dashboardBean.periodMode eq 'MONTH' ? 'lg:col-span-3' :
                                       dashboardBean.periodMode eq 'RANGE' ? 'lg:col-span-3' : 'lg:col-span-4'}">
                <div class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Mode</div>
                <h:selectOneMenu value="#{dashboardBean.periodMode}"
                                 styleClass="mt-2 w-full h-12 rounded-2xl border border-slate-200 bg-white px-4 text-sm
                                            focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300">
                    <f:selectItem itemValue="DAY" itemLabel="Single day"/>
                    <f:selectItem itemValue="MONTH" itemLabel="Single month"/>
                    <f:selectItem itemValue="YEAR" itemLabel="Single year"/>
                    <f:selectItem itemValue="RANGE" itemLabel="Custom range"/>
                    <f:ajax listener="#{dashboardBean.onModeChanged}"
                            render="primaryField monthYearField modeField applyField heroPanel dashPanel appliedLabel"
                            onevent="dashAjaxEvent"/>
                </h:selectOneMenu>
            </h:panelGroup>

            <!-- YEAR (ONLY FOR MONTH MODE) -->
            <h:panelGroup id="monthYearField"
                          layout="block"
                          styleClass="#{dashboardBean.periodMode eq 'MONTH' ? 'lg:col-span-2' : 'hidden'}">
                <div class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Year</div>
                <h:selectOneMenu value="#{dashboardBean.selectedYear}"
                                 styleClass="mt-2 w-full h-12 rounded-2xl border border-slate-200 bg-white px-4 text-sm
                                            focus:outline-none focus:ring-2 focus:ring-slate-200 focus:border-slate-300">
                    <f:selectItems value="#{dashboardBean.yearOptions}"/>
                    <f:ajax event="change"
                            listener="#{dashboardBean.applyFilter}"
                            render="heroPanel dashPanel appliedLabel"
                            onevent="dashAjaxEvent"/>
                </h:selectOneMenu>
            </h:panelGroup>

            <!-- APPLY -->
            <h:panelGroup id="applyField"
                          layout="block"
                          styleClass="#{dashboardBean.periodMode eq 'MONTH' ? 'lg:col-span-3' :
                                       dashboardBean.periodMode eq 'RANGE' ? 'lg:col-span-3' : 'lg:col-span-4'}">
                <h:commandButton value="Apply"
                                 action="#{dashboardBean.applyFilter}"
                                 styleClass="h-12 w-full lg:w-auto lg:float-right min-w-[140px] whitespace-nowrap
                                            rounded-2xl bg-slate-900 px-6 text-sm font-semibold text-white shadow hover:bg-black">
                    <f:ajax render="heroPanel dashPanel appliedLabel" onevent="dashAjaxEvent"/>
                </h:commandButton>
            </h:panelGroup>

        </div>
    </div>
</section>

                <!-- Messages -->
                <h:messages globalOnly="true"
                            styleClass="rounded-2xl border border-rose-100 bg-rose-50 px-4 py-3 text-sm text-rose-700"/>

                <h:panelGroup id="dashPanel" layout="block" styleClass="space-y-7">

                    <!-- KPI -->
                    <section class="space-y-3">
                        <div class="flex items-end justify-between gap-3">
                            <div>
                                <p class="text-[11px] font-semibold tracking-[0.20em] uppercase text-slate-400">Key metrics</p>
                                <p class="mt-1 text-sm text-slate-500">A quick snapshot for the selected period.</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-6 gap-5">

                            <div class="rounded-3xl border border-slate-100 bg-white/90 shadow-xl shadow-slate-200/50 p-5 hover:shadow-lg hover:-translate-y-0.5 transition">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Customers</p>
                                        <p class="mt-2 text-3xl font-bold text-slate-900 leading-none">#{dashboardBean.totalUsers}</p>
                                        <p class="mt-2 text-xs text-slate-500">Active customer accounts.</p>
                                    </div>
                                    <span class="h-10 w-10 rounded-2xl bg-slate-900/5 border border-slate-100 flex items-center justify-center">
                                        <span class="h-2.5 w-2.5 rounded-full bg-slate-900/60"></span>
                                    </span>
                                </div>
                            </div>

                            <div class="rounded-3xl border border-slate-100 bg-white/90 shadow-xl shadow-slate-200/50 p-5 hover:shadow-lg hover:-translate-y-0.5 transition">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Restaurants</p>
                                        <p class="mt-2 text-3xl font-bold text-slate-900 leading-none">#{dashboardBean.totalRestaurants}</p>
                                        <p class="mt-2 text-xs text-slate-500">Active partners operating.</p>
                                    </div>
                                    <span class="h-10 w-10 rounded-2xl bg-slate-900/5 border border-slate-100 flex items-center justify-center">
                                        <span class="h-2.5 w-2.5 rounded-full bg-slate-900/60"></span>
                                    </span>
                                </div>
                            </div>

                            <div class="rounded-3xl border border-slate-100 bg-white/90 shadow-xl shadow-slate-200/50 p-5 hover:shadow-lg hover:-translate-y-0.5 transition">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Bookings</p>
                                        <p class="mt-2 text-3xl font-bold text-slate-900 leading-none">#{dashboardBean.totalBookings}</p>
                                        <p class="mt-2 text-xs text-slate-500">Total bookings in period.</p>
                                    </div>
                                    <span class="h-10 w-10 rounded-2xl bg-slate-900/5 border border-slate-100 flex items-center justify-center">
                                        <span class="h-2.5 w-2.5 rounded-full bg-slate-900/60"></span>
                                    </span>
                                </div>
                            </div>

                            <div class="rounded-3xl border border-slate-100 bg-white/90 shadow-xl shadow-slate-200/50 p-5 hover:shadow-lg hover:-translate-y-0.5 transition">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Pending approvals</p>
                                        <p class="mt-2 text-3xl font-bold text-amber-600 leading-none">#{dashboardBean.pendingApprovals}</p>
                                        <p class="mt-2 text-xs text-slate-500">Waiting for approval.</p>
                                    </div>
                                    <span class="h-10 w-10 rounded-2xl bg-amber-500/10 border border-amber-100 flex items-center justify-center">
                                        <span class="h-2.5 w-2.5 rounded-full bg-amber-600"></span>
                                    </span>
                                </div>
                            </div>

                            <div class="rounded-3xl border border-slate-100 bg-white/90 shadow-xl shadow-slate-200/50 p-5 hover:shadow-lg hover:-translate-y-0.5 transition">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Revenue</p>
                                        <p class="mt-2 text-2xl font-bold text-slate-900 leading-none whitespace-nowrap">
                                            #{dashboardBean.formattedMonthlyRevenue}
                                        </p>
                                        <p class="mt-2 text-xs text-slate-500">Booking revenue in period.</p>
                                    </div>
                                    <span class="h-10 w-10 rounded-2xl bg-emerald-500/10 border border-emerald-100 flex items-center justify-center">
                                        <span class="h-2.5 w-2.5 rounded-full bg-emerald-600"></span>
                                    </span>
                                </div>
                            </div>

                            <div class="rounded-3xl border border-slate-100 bg-white/90 shadow-xl shadow-slate-200/50 p-5 hover:shadow-lg hover:-translate-y-0.5 transition">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Cancellation rate</p>
                                        <p class="mt-2 text-3xl font-bold text-rose-600 leading-none">#{dashboardBean.cancelRate}%</p>
                                        <p class="mt-2 text-xs text-slate-500">Cancelled bookings ratio.</p>
                                    </div>
                                    <span class="h-10 w-10 rounded-2xl bg-rose-500/10 border border-rose-100 flex items-center justify-center">
                                        <span class="h-2.5 w-2.5 rounded-full bg-rose-600"></span>
                                    </span>
                                </div>
                            </div>

                        </div>
                    </section>

                    <!-- CHARTS -->
                    <section class="grid grid-cols-1 xl:grid-cols-3 gap-6">

                        <div class="xl:col-span-2 rounded-3xl bg-white/90 border border-slate-100 shadow-xl shadow-slate-200/50 p-6">
                            <div class="flex items-start justify-between gap-3 mb-4">
                                <div>
                                    <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Revenue</p>
                                    <h3 class="mt-1 text-lg font-semibold text-slate-900">Trend</h3>
                                    <p class="mt-1 text-sm text-slate-500">Revenue over time (auto-adjusts by mode).</p>
                                </div>
                            </div>

                            <div class="h-[300px]">
                                <canvas id="revChart"></canvas>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="rounded-3xl bg-white/90 border border-slate-100 shadow-xl shadow-slate-200/50 p-6">
                                <div class="mb-4">
                                    <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Bookings</p>
                                    <h3 class="mt-1 text-lg font-semibold text-slate-900">Status distribution</h3>
                                    <p class="mt-1 text-sm text-slate-500">Booking status breakdown in period.</p>
                                </div>

                                <div class="h-[220px]">
                                    <canvas id="statusChart"></canvas>
                                </div>

                                <div class="mt-4 grid grid-cols-3 gap-3 text-center">
                                    <div class="rounded-2xl border border-slate-100 bg-slate-50/80 p-3">
                                        <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Confirmed</p>
                                        <p class="mt-1 text-lg font-bold text-slate-900">#{dashboardBean.confirmedCount}</p>
                                    </div>
                                    <div class="rounded-2xl border border-slate-100 bg-slate-50/80 p-3">
                                        <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Pending</p>
                                        <p class="mt-1 text-lg font-bold text-slate-900">#{dashboardBean.pendingCount}</p>
                                    </div>
                                    <div class="rounded-2xl border border-slate-100 bg-slate-50/80 p-3">
                                        <p class="text-[11px] uppercase tracking-[0.16em] text-slate-400">Cancelled</p>
                                        <p class="mt-1 text-lg font-bold text-slate-900">#{dashboardBean.cancelledCount}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="rounded-3xl bg-white/90 border border-slate-100 shadow-xl shadow-slate-200/50 p-6">
                                <div class="mb-4">
                                    <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Cancellations</p>
                                    <h3 class="mt-1 text-lg font-semibold text-slate-900">Cancel rate</h3>
                                    <p class="mt-1 text-sm text-slate-500">Cancellation rate over time.</p>
                                </div>

                                <div class="h-[220px]">
                                    <canvas id="cancelChart"></canvas>
                                </div>
                            </div>
                        </div>

                    </section>

                    <!-- JSON DATA for charts -->
                    <script type="application/json" id="revData">
                        <h:outputText value="#{dashboardBean.revenueByMonthJson}" escape="false"/>
                    </script>
                    <script type="application/json" id="statusData">
                        <h:outputText value="#{dashboardBean.bookingsByStatusJson}" escape="false"/>
                    </script>
                    <script type="application/json" id="cancelData">
                        <h:outputText value="#{dashboardBean.cancelRateByMonthJson}" escape="false"/>
                    </script>

                    <!-- RECENT BOOKINGS -->
                    <section class="bg-white/90 rounded-3xl p-6 md:p-8 shadow-xl border border-slate-100">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <p class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">Recent</p>
                                <h3 class="mt-1 text-lg font-semibold text-slate-900">Latest bookings</h3>
                                <p class="mt-1 text-sm text-slate-500">Most recent booking activity (filtered).</p>
                            </div>
                        </div>

                        <div class="mt-6 overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="text-left text-[11px] uppercase tracking-[0.16em] text-slate-400 border-b border-slate-100">
                                        <th class="py-3 pr-4">Code</th>
                                        <th class="py-3 pr-4">Customer</th>
                                        <th class="py-3 pr-4">Restaurant</th>
                                        <th class="py-3 pr-4">Date</th>
                                        <th class="py-3 pr-4">Guests</th>
                                        <th class="py-3 pr-4">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <ui:repeat value="#{dashboardBean.recentBookings}" var="b">
                                        <tr class="hover:bg-slate-50/70 transition">
                                            <td class="py-3 pr-4 font-semibold text-slate-900">#{b.bookingCode}</td>
                                            <td class="py-3 pr-4 text-slate-700">#{b.contactFullName}</td>
                                            <td class="py-3 pr-4 text-slate-700">#{dashboardBean.restaurantName(b)}</td>
                                            <td class="py-3 pr-4 text-slate-700">#{b.eventDate}</td>
                                            <td class="py-3 pr-4 text-slate-700">#{b.guestCount}</td>
                                            <td class="py-3 pr-4">
                                                <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">
                                                    #{b.bookingStatus}
                                                </span>
                                            </td>
                                        </tr>
                                    </ui:repeat>
                                </tbody>
                            </table>
                        </div>
                    </section>

                </h:panelGroup>

                <!-- Chart render (supports AJAX re-render) -->
                <script>
                    //<![CDATA[
                    window._dashCharts = window._dashCharts || {};

                    function safeJson(id, fallback) {
                        try {
                            const el = document.getElementById(id);
                            const txt = (el && el.textContent) ? el.textContent.trim() : '';
                            if (!txt) return fallback;
                            return JSON.parse(txt);
                        } catch (e) {
                            return fallback;
                        }
                    }

                    function destroyDashCharts() {
                        try {
                            Object.values(window._dashCharts).forEach(c => {
                                try { c.destroy(); } catch (e) {}
                            });
                        } catch (e) {}
                        window._dashCharts = {};
                    }

                    function renderDashboardCharts() {
                        if (typeof Chart === 'undefined') return;

                        destroyDashCharts();

                        const rev = safeJson('revData', {labels:[], values:[]});
                        const stt = safeJson('statusData', {labels:[], values:[]});
                        const cnl = safeJson('cancelData', {labels:[], values:[]});

                        const revCtx = document.getElementById('revChart');
                        if (revCtx) {
                            window._dashCharts.rev = new Chart(revCtx, {
                                type: 'line',
                                data: {
                                    labels: rev.labels || [],
                                    datasets: [{
                                        label: 'Revenue',
                                        data: rev.values || [],
                                        tension: 0.35,
                                        borderWidth: 2,
                                        pointRadius: 2,
                                        fill: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    interaction: { mode: 'index', intersect: false },
                                    scales: {
                                        x: { grid: { display: false } },
                                        y: { beginAtZero: true }
                                    }
                                }
                            });
                        }

                        const sttCtx = document.getElementById('statusChart');
                        if (sttCtx) {
                            window._dashCharts.status = new Chart(sttCtx, {
                                type: 'doughnut',
                                data: {
                                    labels: stt.labels || [],
                                    datasets: [{ data: stt.values || [], borderWidth: 1 }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { position: 'bottom' } },
                                    cutout: '65%'
                                }
                            });
                        }

                        const cnlCtx = document.getElementById('cancelChart');
                        if (cnlCtx) {
                            window._dashCharts.cancel = new Chart(cnlCtx, {
                                type: 'bar',
                                data: {
                                    labels: cnl.labels || [],
                                    datasets: [{
                                        label: 'Cancel rate (%)',
                                        data: cnl.values || [],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: {
                                        x: { grid: { display: false } },
                                        y: {
                                            beginAtZero: true,
                                            suggestedMax: 100,
                                            ticks: { callback: (v) => v + '%' }
                                        }
                                    }
                                }
                            });
                        }
                    }

                    window.addEventListener('load', renderDashboardCharts);

                    function dashAjaxEvent(data) {
                        if (data && data.status === 'success') {
                            renderDashboardCharts();
                        }
                    }
                    //]]>
                </script>

            </h:form>
        </div>

    </ui:define>
</ui:composition>
