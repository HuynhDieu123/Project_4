<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition
        template="template.xhtml"
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:h="jakarta.faces.html"
        xmlns:f="jakarta.faces.core"
        xmlns:ui="jakarta.faces.facelets">

    <ui:define name="title">Favorite Restaurants Analytics</ui:define>

    <ui:define name="content">

        <h:form id="statsForm">

            <!-- HEADER -->
            <div class="flex items-start justify-between mb-6 gap-3">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">
                        Favorite Restaurants Analytics
                    </h2>
                    <p class="text-sm text-gray-500">
                        Track and manage users’ favorite restaurants (filter, sort, top N).
                    </p>
                </div>

                <div class="flex items-center gap-2">
                    <h:commandButton value="Recompute"
                                     action="#{adminFavoritesStatsBean.recompute}"
                                     styleClass="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm" />
                </div>
            </div>

            <!-- KPI -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
                <div class="bg-white p-4 rounded-2xl shadow border border-gray-200">
                    <div class="text-xs text-gray-500">Total Favorite Records</div>
                    <div class="mt-1 text-3xl font-semibold text-gray-900">
                        #{adminFavoritesStatsBean.totalFavoriteRecords}
                    </div>
                    <div class="mt-1 text-xs text-gray-400">
                        Total rows in the FavoriteRestaurants table
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow border border-gray-200">
                    <div class="text-xs text-gray-500">Unique Customers</div>
                    <div class="mt-1 text-3xl font-semibold text-gray-900">
                        #{adminFavoritesStatsBean.uniqueCustomerCount}
                    </div>
                    <div class="mt-1 text-xs text-gray-400">
                        Number of distinct users who favorited restaurants
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow border border-gray-200">
                    <div class="text-xs text-gray-500">Unique Restaurants</div>
                    <div class="mt-1 text-3xl font-semibold text-gray-900">
                        #{adminFavoritesStatsBean.uniqueRestaurantCount}
                    </div>
                    <div class="mt-1 text-xs text-gray-400">
                        Number of restaurants with at least one favorite
                    </div>
                </div>
            </div>

            <!-- FILTER BAR -->
            <div class="bg-white p-4 rounded-2xl shadow mb-5 border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">

                    <!-- keyword -->
                    <div class="md:col-span-2">
                        <label class="block text-xs font-semibold text-gray-600 mb-1">
                            Keyword (Name / ID)
                        </label>
                        <h:inputText value="#{adminFavoritesStatsBean.keyword}"
                                     styleClass="p-2.5 border rounded-xl text-sm w-full"
                                     title="Search by restaurant name or ID" />
                    </div>

                    <!-- city -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">
                            City
                        </label>
                        <h:inputText value="#{adminFavoritesStatsBean.cityKeyword}"
                                     styleClass="p-2.5 border rounded-xl text-sm w-full"
                                     title="Filter by city name" />
                    </div>

                    <!-- min favorites -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">
                            Minimum Favorites
                        </label>
                        <h:inputText value="#{adminFavoritesStatsBean.minFavorites}"
                                     styleClass="p-2.5 border rounded-xl text-sm w-full"
                                     title="Show restaurants with favorites >= this value" />
                    </div>

                    <!-- sort -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">
                            Sort By
                        </label>
                        <h:selectOneMenu value="#{adminFavoritesStatsBean.sortBy}"
                                         styleClass="p-2.5 border rounded-xl text-sm w-full">
                            <f:selectItem itemValue="FAV_DESC" itemLabel="Favorites (Descending)" />
                            <f:selectItem itemValue="FAV_ASC" itemLabel="Favorites (Ascending)" />
                            <f:selectItem itemValue="RATING_DESC" itemLabel="Rating (Descending)" />
                            <f:selectItem itemValue="NAME_ASC" itemLabel="Name (A → Z)" />
                            <f:selectItem itemValue="NEWEST" itemLabel="Newest Restaurants" />
                        </h:selectOneMenu>
                    </div>

                    <!-- top -->
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">
                            Top
                        </label>
                        <h:selectOneMenu value="#{adminFavoritesStatsBean.top}"
                                         styleClass="p-2.5 border rounded-xl text-sm w-full">
                            <f:selectItem itemValue="20" itemLabel="Top 20" />
                            <f:selectItem itemValue="50" itemLabel="Top 50" />
                            <f:selectItem itemValue="100" itemLabel="Top 100" />
                            <f:selectItem itemValue="200" itemLabel="Top 200" />
                        </h:selectOneMenu>
                    </div>

                    <!-- buttons -->
                    <div class="md:col-span-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="text-xs text-gray-400">
                            Last updated:
                            <h:outputText value="#{adminFavoritesStatsBean.lastRecomputedAt}">
                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm"
                                                   timeZone="Asia/Ho_Chi_Minh" />
                            </h:outputText>
                        </div>

                        <div class="flex gap-2">
                            <h:commandButton value="Apply Filters"
                                             action="#{adminFavoritesStatsBean.applyFilters}"
                                             styleClass="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm w-full md:w-auto" />
                            <h:commandButton value="Reset"
                                             action="#{adminFavoritesStatsBean.clearFilters}"
                                             styleClass="px-4 py-2 rounded-xl bg-gray-100 text-sm w-full md:w-auto" />
                        </div>
                    </div>

                </div>
            </div>

            <!-- TABLE LIST -->
            <div class="bg-white p-4 rounded-3xl shadow border border-gray-200">

                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm font-semibold text-gray-900">
                        Statistics Table
                    </div>
                    <div class="text-xs text-gray-500">
                        Showing: #{adminFavoritesStatsBean.displayedStats.size()} rows
                    </div>
                </div>

                <table class="w-full text-sm">
                    <thead>
                    <tr class="border-b text-gray-500">
                        <th class="py-3 text-left">Restaurant</th>
                        <th class="text-left">Location</th>
                        <th class="text-left">Favorites</th>
                        <th class="text-left">Unique Users</th>
                        <th class="text-left">Average Rating</th>
                      
                        <th class="text-left">Created At</th>
                    </tr>
                    </thead>

                    <tbody>
                    <ui:repeat value="#{adminFavoritesStatsBean.displayedStats}" var="row">
                        <tr class="border-b last:border-b-0 hover:bg-gray-50">
                            <!-- Restaurant -->
                            <td class="py-3 align-top">
                                <div class="font-medium text-gray-900">
                                    #{row.restaurant.name}
                                </div>
                                <div class="text-xs text-gray-500">
                                    ##{row.restaurant.restaurantId}
                                </div>
                            </td>

                            <!-- Location -->
                            <td class="align-top text-xs text-gray-700">
                                <h:panelGroup rendered="#{not empty row.restaurant.areaId and not empty row.restaurant.areaId.cityId}">
                                    #{row.restaurant.areaId.cityId.name}
                                    <h:panelGroup rendered="#{not empty row.restaurant.areaId.name}">
                                        &#160;•&#160;#{row.restaurant.areaId.name}
                                    </h:panelGroup>
                                </h:panelGroup>

                                <h:panelGroup rendered="#{empty row.restaurant.areaId}">
                                    <span class="text-gray-400">—</span>
                                </h:panelGroup>
                            </td>

                            <!-- Favorites -->
                            <td class="align-top">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-rose-50 text-rose-700">
                                    ♥ #{row.favoriteCount}
                                </span>
                            </td>

                            <!-- Unique Users -->
                            <td class="align-top">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
                                    #{row.uniqueCustomers}
                                </span>
                            </td>

                            <!-- Rating -->
                            <td class="align-top">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-amber-50 text-amber-700">
                                    ★ #{adminFavoritesStatsBean.averageRatingFormatted(row)}
                                </span>
                            </td>

                         

                            <!-- Created at -->
                            <td class="align-top text-xs text-gray-500">
                                <h:outputText value="#{row.createdAt}">
                                    <f:convertDateTime pattern="dd/MM/yyyy"
                                                       timeZone="Asia/Ho_Chi_Minh" />
                                </h:outputText>
                            </td>
                        </tr>
                    </ui:repeat>

                    <!-- Empty state -->
                    <h:panelGroup rendered="#{empty adminFavoritesStatsBean.displayedStats}">
                        <tr>
                            <td colspan="7" class="py-6">
                                <div class="text-sm text-gray-500">
                                    No data matches your current filters. Try lowering “Minimum Favorites” or clearing the keyword/city filters.
                                </div>
                            </td>
                        </tr>
                    </h:panelGroup>
                    </tbody>
                </table>

                <h:messages styleClass="mt-3 text-sm"
                            errorClass="text-red-500"
                            infoClass="text-green-600"
                            warnClass="text-amber-500" />

            </div>

        </h:form>

    </ui:define>

</ui:composition>
