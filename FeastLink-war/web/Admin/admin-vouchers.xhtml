<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition
        template="template.xhtml"
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:h="jakarta.faces.html"
        xmlns:f="jakarta.faces.core"
        xmlns:ui="jakarta.faces.facelets"
        xmlns:pt="jakarta.faces.passthrough">

    <ui:define name="title">Vouchers Management</ui:define>

    <ui:define name="content">

        <h:form id="voucherForm">

            <!-- HEADER -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Vouchers Management</h2>
                    <p class="text-sm text-gray-500">
                        Quản lý các mã giảm giá cho hệ thống FeastLink.
                    </p>
                </div>

                <div>
                    <h:commandButton value="Create new voucher"
                                     action="#{adminVoucherBean.prepareCreate}"
                                     styleClass="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm" />
                </div>
            </div>

            <!-- FILTER BAR -->
            <div class="bg-white p-4 rounded-2xl shadow mb-5 border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

                    <!-- keyword -->
                    <h:inputText value="#{adminVoucherBean.keyword}"
                                 styleClass="p-2.5 border rounded-xl text-sm w-full"
                                 title="Tìm theo code hoặc tên voucher"
                                />

                    <!-- scope filter -->
                    <h:selectOneMenu value="#{adminVoucherBean.scopeFilter}"
                                     styleClass="p-2.5 border rounded-xl text-sm w-full">
                        <f:selectItem itemValue="ALL" itemLabel="Tất cả phạm vi" />
                        <f:selectItem itemValue="GLOBAL" itemLabel="GLOBAL" />
                        <f:selectItem itemValue="RESTAURANT" itemLabel="RESTAURANT" />
                        <f:selectItem itemValue="CUSTOMER" itemLabel="CUSTOMER" />
                    </h:selectOneMenu>

                    <!-- status filter -->
                    <h:selectOneMenu value="#{adminVoucherBean.statusFilter}"
                                     styleClass="p-2.5 border rounded-xl text-sm w-full">
                        <f:selectItem itemValue="ALL" itemLabel="Tất cả trạng thái" />
                        <f:selectItem itemValue="ACTIVE" itemLabel="ACTIVE" />
                        <f:selectItem itemValue="INACTIVE" itemLabel="INACTIVE" />
                        <f:selectItem itemValue="EXPIRED" itemLabel="EXPIRED" />
                    </h:selectOneMenu>

                    <!-- buttons -->
                    <div class="flex gap-2">
                        <h:commandButton value="Filter"
                                         action="#{adminVoucherBean.applyFilter}"
                                         styleClass="px-4 py-2 rounded-xl bg-blue-600 text-white text-sm w-full md:w-auto" />
                        <h:commandButton value="Reset"
                                         action="#{adminVoucherBean.clearFilter}"
                                         styleClass="px-4 py-2 rounded-xl bg-gray-100 text-sm w-full md:w-auto" />
                    </div>

                </div>
            </div>

            <!-- TABLE LIST -->
            <div class="bg-white p-4 rounded-3xl shadow border border-gray-200">

                <table class="w-full text-sm">
                    <thead>
                    <tr class="border-b text-gray-500">
                        <th class="py-3 text-left">Mã / Tên</th>
                        <th class="text-left">Phạm vi</th>
                        <th class="text-left">Giảm giá</th>
                        <th class="text-left">Điều kiện</th>
                        <th class="text-left">Có hiệu lực</th>
                        <th class="text-left">Trạng thái</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                    </thead>

                    <tbody>
                    <ui:repeat value="#{adminVoucherBean.voucherList}" var="v">
                        <tr class="border-b last:border-b-0 hover:bg-gray-50">
                            <!-- Code + Name -->
                            <td class="py-3 align-top">
                                <div class="font-semibold text-gray-900">
                                    #{v.code}
                                </div>
                                <div class="text-xs text-gray-500">
                                    #{v.name}
                                </div>
                                <div class="text-[10px] text-gray-400">
                                    ##{v.voucherId}
                                </div>
                            </td>

                            <!-- Scope -->
                            <td class="align-top text-xs text-gray-700">
                                #{v.scope}
                            </td>

                            <!-- Discount info -->
                            <td class="align-top text-xs text-gray-700">
                                <div>
                                    Loại: #{v.discountType}
                                </div>
                                <div>
                                    Giá trị:
                                    <h:outputText value="#{v.discountValue}" />
                                </div>
                                <ui:fragment rendered="#{v.maxDiscount != null}">
                                    <div>Giảm tối đa:
                                        <h:outputText value="#{v.maxDiscount}" />
                                    </div>
                                </ui:fragment>
                            </td>

                            <!-- Conditions -->
                            <td class="align-top text-xs text-gray-700">
                                <ui:fragment rendered="#{v.minOrderAmount != null}">
                                    <div>Đơn tối thiểu:
                                        <h:outputText value="#{v.minOrderAmount}" />
                                    </div>
                                </ui:fragment>
                                <ui:fragment rendered="#{v.totalQuantity != null}">
                                    <div>Tổng số lượng: #{v.totalQuantity}</div>
                                </ui:fragment>
                                <ui:fragment rendered="#{v.perUserLimit != null}">
                                    <div>Giới hạn / người: #{v.perUserLimit}</div>
                                </ui:fragment>
                                <div class="mt-1 text-[11px] text-gray-500">
                                    Đổi bằng điểm:
                                    <h:outputText value="#{v.isPointRedeemable ? 'Có' : 'Không'}" />
                                </div>
                                <ui:fragment rendered="#{v.isPointRedeemable and v.pointCost != null}">
                                    <div class="text-[11px] text-gray-500">
                                        Chi phí điểm: #{v.pointCost}
                                    </div>
                                </ui:fragment>
                            </td>

                            <!-- Valid date -->
                            <td class="align-top text-xs text-gray-700">
                                <div>
                                    <span class="text-gray-400">Bắt đầu:</span>
                                    <h:outputText value="#{v.startAt}">
                                        <f:convertDateTime pattern="dd/MM/yyyy"
                                                           timeZone="Asia/Ho_Chi_Minh" />
                                    </h:outputText>
                                </div>
                                <div>
                                    <span class="text-gray-400">Kết thúc:</span>
                                    <h:outputText value="#{v.endAt}">
                                        <f:convertDateTime pattern="dd/MM/yyyy"
                                                           timeZone="Asia/Ho_Chi_Minh" />
                                    </h:outputText>
                                </div>
                            </td>

                            <!-- Status -->
                            <td class="align-top text-xs text-gray-700">
                                #{v.status}
                            </td>

                            <!-- Actions -->
                            <td class="align-top text-center">
                                <div class="flex flex-col items-center gap-1">
                                    <h:commandButton value="Sửa"
                                                     action="#{adminVoucherBean.prepareEdit(v)}"
                                                     styleClass="px-3 py-1.5 rounded-lg bg-amber-500 text-white text-xs" />
                                    <h:commandButton value="Xoá"
                                                     action="#{adminVoucherBean.deleteVoucher(v)}"
                                                     immediate="true"
                                                     onclick="return confirm('Xoá voucher này?');"
                                                     styleClass="px-3 py-1.5 rounded-lg bg-red-500 text-white text-xs" />
                                </div>
                            </td>
                        </tr>
                    </ui:repeat>
                    </tbody>
                </table>

                <!-- EDIT / CREATE PANEL -->
                <h:panelGroup rendered="#{adminVoucherBean.selectedVoucher != null}">
                    <hr class="my-4" />

                    <h3 class="text-sm font-semibold mb-2">
                        <ui:fragment rendered="#{adminVoucherBean.createMode}">
                            Tạo phiếu giảm giá mới
                        </ui:fragment>
                        <ui:fragment rendered="#{not adminVoucherBean.createMode}">
                            Chỉnh sửa phiếu giảm giá ##{adminVoucherBean.selectedVoucher.voucherId}
                        </ui:fragment>
                    </h3>

                    <!-- BASIC INFO -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-600">Mã số</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.code}"
                                         maxlength="50"
                                         required="true"
                                         requiredMessage="Mã voucher không được bỏ trống"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm" />
                        </div>

                        <div class="md:col-span-2">
                            <label class="text-xs font-semibold text-gray-600">Tên</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.name}"
                                         maxlength="150"
                                         required="true"
                                         requiredMessage="Tên voucher không được bỏ trống"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm" />
                        </div>
                    </div>

                    <!-- SCOPE + DISCOUNT TYPE + STATUS -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-600">Phạm vi</label>
                            <h:selectOneMenu value="#{adminVoucherBean.selectedVoucher.scope}"
                                             styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:selectItem itemValue="CUSTOMER" itemLabel="KHÁCH HÀNG" />
                                <f:selectItem itemValue="RESTAURANT" itemLabel="NHÀ HÀNG" />
                                <f:selectItem itemValue="GLOBAL" itemLabel="TOÀN HỆ THỐNG" />
                            </h:selectOneMenu>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-600">Loại giảm giá</label>
                            <h:selectOneMenu value="#{adminVoucherBean.selectedVoucher.discountType}"
                                             styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:selectItem itemValue="PERCENT" itemLabel="PHẦN TRĂM" />
                                <f:selectItem itemValue="AMOUNT" itemLabel="SỐ TIỀN" />
                            </h:selectOneMenu>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-600">Trạng thái</label>
                            <h:selectOneMenu value="#{adminVoucherBean.selectedVoucher.status}"
                                             styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:selectItem itemValue="ACTIVE" itemLabel="TÍCH CỰC" />
                                <f:selectItem itemValue="INACTIVE" itemLabel="NGƯNG" />
                                <f:selectItem itemValue="EXPIRED" itemLabel="HẾT HẠN" />
                            </h:selectOneMenu>
                        </div>
                    </div>

                    <!-- DISCOUNT VALUES -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-600">Giá trị chiết khấu</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.discountValue}"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:convertNumber />
                            </h:inputText>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-600">Giảm giá tối đa</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.maxDiscount}"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:convertNumber />
                            </h:inputText>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-600">Số tiền đặt hàng tối thiểu</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.minOrderAmount}"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:convertNumber />
                            </h:inputText>
                        </div>
                    </div>

                    <!-- QUANTITY & LIMIT & POINT -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-600">Tổng số lượng</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.totalQuantity}"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:convertNumber integerOnly="true" />
                            </h:inputText>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-600">Giới hạn cho mỗi người dùng</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.perUserLimit}"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:convertNumber integerOnly="true" />
                            </h:inputText>
                        </div>

                        <div class="flex items-center mt-5 gap-2">
                            <h:selectBooleanCheckbox value="#{adminVoucherBean.selectedVoucher.isPointRedeemable}"
                                                     styleClass="h-4 w-4" />
                            <label class="text-xs font-semibold text-gray-600">
                                Đổi bằng điểm
                            </label>
                        </div>
                    </div>

                    <!-- POINT COST + DATES (DATE PICKER) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-600">Chi phí điểm</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.pointCost}"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:convertNumber integerOnly="true" />
                            </h:inputText>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-600">Ngày bắt đầu</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.startAt}"
                                         pt:type="date"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:convertDateTime pattern="yyyy-MM-dd"
                                                   timeZone="Asia/Ho_Chi_Minh" />
                            </h:inputText>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-600">Ngày kết thúc</label>
                            <h:inputText value="#{adminVoucherBean.selectedVoucher.endAt}"
                                         pt:type="date"
                                         styleClass="mt-1 w-full p-2 border rounded-xl text-sm">
                                <f:convertDateTime pattern="yyyy-MM-dd"
                                                   timeZone="Asia/Ho_Chi_Minh" />
                            </h:inputText>
                        </div>
                    </div>

                    <!-- ACTION BUTTONS -->
                    <div class="flex justify-end gap-2 mt-4">
                        <h:commandButton value="Hủy bỏ"
                                         action="#{adminVoucherBean.cancelEdit}"
                                         immediate="true"
                                         styleClass="px-4 py-2 bg-gray-100 text-sm rounded-xl" />
                        <h:commandButton value="Lưu"
                                         action="#{adminVoucherBean.saveVoucher}"
                                         styleClass="px-4 py-2 bg-blue-600 text-white text-sm rounded-xl" />
                    </div>
                </h:panelGroup>

                <!-- MESSAGES -->
                <h:messages styleClass="mt-3 text-sm"
                            errorClass="text-red-500"
                            infoClass="text-green-600"
                            warnClass="text-amber-500" />

            </div>

        </h:form>

    </ui:define>

</ui:composition>
