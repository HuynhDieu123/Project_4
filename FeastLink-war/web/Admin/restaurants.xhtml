<!DOCTYPE html>
<ui:composition 
    template="template.xhtml"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="jakarta.faces.html"
    xmlns:ui="jakarta.faces.facelets"
    xmlns:f="jakarta.faces.core"
    xmlns:pass="jakarta.faces.passthrough">

    <ui:define name="title">Restaurant Management</ui:define>

    <ui:define name="content">

        <!-- HEADER -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Restaurant Management</h1>
                <p class="text-sm text-gray-500">
                    Manage restaurants for the OnlineCatering system.
                </p>
            </div>

            <button type="button"
                    class="px-5 py-3 bg-blue-600 text-white rounded-2xl shadow hover:bg-blue-700 font-semibold text-sm"
                    onclick="document.getElementById('addRestaurantModal').showModal()">
                <span class="align-middle mr-1">+</span> Add Restaurant
            </button>
        </div>

        <!-- MAIN FORM -->
        <h:form id="restaurantMainForm">

            <!-- FILTER CARD -->
            <div class="bg-white p-5 rounded-2xl shadow border border-gray-200 mb-6">

                <div class="flex flex-wrap gap-4 items-end justify-between">

                    <!-- 3 field trong card nhỏ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1">

                        <!-- Search -->
                        <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                            <label class="block text-xs font-medium text-gray-600 mb-2">
                                Search (name / email / phone / contact)
                            </label>
                            <h:inputText value="#{restaurantsBean.keyword}"
                                         styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                         focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                         pass:placeholder="Search restaurants..." />
                        </div>

                        <!-- Status -->
                        <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                            <label class="block text-xs font-medium text-gray-600 mb-2">
                                Status
                            </label>
                            <h:selectOneMenu value="#{restaurantsBean.statusFilter}"
                                             styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                             focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <f:selectItem itemValue="ALL" itemLabel="All" />
                                <f:selectItem itemValue="ACTIVE" itemLabel="Active" />
                                <f:selectItem itemValue="INACTIVE" itemLabel="Inactive" />
                            </h:selectOneMenu>
                        </div>

                        <!-- City -->
                        <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                            <label class="block text-xs font-medium text-gray-600 mb-2">
                                City
                            </label>
                            <h:selectOneMenu value="#{restaurantsBean.cityFilterId}"
                                             styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                             focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                <f:selectItem itemValue="#{null}" itemLabel="All cities" noSelectionOption="true" />
                                <f:selectItems value="#{restaurantsBean.cityList}"
                                               var="c"
                                               itemValue="#{c.cityId}"
                                               itemLabel="#{c.name}" />
                            </h:selectOneMenu>
                        </div>

                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-3">
                        <h:commandButton value="Filter"
                                         action="#{restaurantsBean.applyFilter}"
                                         styleClass="px-5 py-2 rounded-2xl bg-blue-600 text-white text-sm font-semibold
                                         hover:bg-blue-700 shadow-sm">
                            <f:ajax execute="@form" render="@form" />
                        </h:commandButton>

                        <h:commandButton value="Reset"
                                         action="#{restaurantsBean.resetFilter}"
                                         styleClass="px-4 py-2 rounded-2xl border border-gray-200 bg-gray-50
                                         text-gray-700 text-sm font-medium hover:bg-gray-100">
                            <f:ajax execute="@form" render="@form" />
                        </h:commandButton>
                    </div>

                </div>
            </div>

            <!-- TABLE CARD -->
            <div class="bg-white p-6 rounded-2xl shadow border border-gray-200 overflow-x-auto">

                <table class="min-w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Address</th>
                            <th class="px-4 py-3">Area</th>
                            <th class="px-4 py-3">Contact</th>
                            <th class="px-4 py-3">Email</th>
                            <th class="px-4 py-3">Open – Close</th>
                            <th class="px-4 py-3">Min Guests</th>
                            <th class="px-4 py-3">Deposit</th>
                            <th class="px-4 py-3">Status</th>
                            <th class="px-4 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">

                        <!-- ROWS -->
                        <ui:repeat value="#{restaurantsBean.pageRestaurants}" var="r">

                            <tr class="bg-white hover:bg-gray-50">

                                <!-- Name -->
                                <td class="px-4 py-3">
                                    <div class="font-semibold text-gray-900">
                                        #{r.name}
                                    </div>
                                </td>

                                <!-- Address -->
                                <td class="px-4 py-3 text-gray-700">
                                    #{r.address}
                                </td>

                                <!-- Area -->
                                <td class="px-4 py-3 text-gray-700">
                                    #{r.areaId != null ? r.areaId.name : '—'}
                                </td>

                                <!-- Contact -->
                                <td class="px-4 py-3">
                                    <div class="flex flex-col">
                                        <span>#{r.contactPerson}</span>
                                        <span class="text-xs text-gray-500">#{r.phone}</span>
                                    </div>
                                </td>

                                <!-- Email -->
                                <td class="px-4 py-3 text-gray-700">
                                    #{r.email}
                                </td>

                                <!-- Open – Close -->
                                <td class="px-4 py-3 text-gray-700">
                                    #{r.openTime} – #{r.closeTime}
                                </td>

                                <!-- Min guests -->
                                <td class="px-4 py-3 text-gray-700">
                                    #{r.minGuestCount}
                                </td>

                                <!-- Deposit -->
                                <td class="px-4 py-3 text-gray-700">
                                    #{r.defaultDepositPercent != null ? r.defaultDepositPercent : 0}%
                                </td>

                                <!-- Status badge -->
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium
                                          #{restaurantsBean.statusCssClass(r.status)}">
                                        #{r.status}
                                    </span>
                                </td>

                                <!-- Actions -->
                                <td class="px-4 py-3 text-right">
                                    <div class="flex justify-end gap-2">

                                        <!-- View (sau này link qua trang detail) -->
                                        <a href="#"
                                           class="inline-flex items-center px-3 py-1.5 rounded-full border border-gray-300
                                           text-xs font-medium text-gray-700 hover:bg-gray-50">
                                            View
                                        </a>

                                        <!-- Activate / Deactivate -->
                                        <h:commandLink action="#{restaurantsBean.confirmChangeStatus}"
                                                       styleClass="inline-flex items-center px-3 py-1.5 rounded-full border text-xs font-medium
                                                       #{r.status eq 'ACTIVE' 
                                                         ? 'border-red-300 text-red-700 hover:bg-red-50' 
                                                         : 'border-green-300 text-green-700 hover:bg-green-50'}">
                                            <f:setPropertyActionListener value="#{r.restaurantId}"
                                                                         target="#{restaurantsBean.selectedRestaurantId}" />
                                            <f:ajax execute="@this" render=":restaurantMainForm" />
                                            <span>
                                                #{r.status eq 'ACTIVE' ? 'Deactivate' : 'Activate'}
                                            </span>
                                        </h:commandLink>

                                    </div>
                                </td>

                            </tr>

                        </ui:repeat>

                        <!-- NO DATA ROW -->
                        <ui:fragment rendered="#{empty restaurantsBean.pageRestaurants}">
                            <tr>
                                <td colspan="10"
                                    class="px-4 py-6 text-center text-sm text-gray-500">
                                    No restaurants found.
                                </td>
                            </tr>
                        </ui:fragment>

                    </tbody>
                </table>

                <!-- PAGINATION -->
                <div class="flex items-center justify-between mt-4">
                    <h:commandButton value="Previous"
                                     action="#{restaurantsBean.prevPage}"
                                     disabled="#{restaurantsBean.currentPage le 1}"
                                     styleClass="px-3 py-1 rounded-xl border border-gray-300 text-xs text-gray-700 disabled:opacity-50">
                        <f:ajax execute="@form" render="@form" />
                    </h:commandButton>

                    <span class="text-xs text-gray-500">
                        Page #{restaurantsBean.currentPage} / #{restaurantsBean.totalPages}
                    </span>

                    <h:commandButton value="Next"
                                     action="#{restaurantsBean.nextPage}"
                                     disabled="#{restaurantsBean.currentPage ge restaurantsBean.totalPages}"
                                     styleClass="px-3 py-1 rounded-xl border border-gray-300 text-xs text-gray-700 disabled:opacity-50">
                        <f:ajax execute="@form" render="@form" />
                    </h:commandButton>
                </div>

            </div>

        </h:form>

        <!-- ADD RESTAURANT MODAL -->
        <dialog id="addRestaurantModal"
                class="rounded-2xl shadow-xl w-full max-w-2xl">

            <h:form id="addRestaurantForm" styleClass="p-6 space-y-6">

                <!-- Title -->
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">
                        Add Restaurant
                    </h2>
                    <button type="button"
                            class="text-gray-400 hover:text-gray-600 text-xl"
                            onclick="document.getElementById('addRestaurantModal').close()">
                        ×
                    </button>
                </div>

                <!-- BASIC INFO -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                    <!-- Name -->
                    <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                            Name <span class="text-red-500">*</span>
                        </label>
                        <h:inputText id="name"
                                     value="#{restaurantsBean.newRestaurant.name}"
                                     styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                     pass:placeholder="Restaurant name" />
                        <h:message for="name"
                                   styleClass="mt-1 text-xs text-red-500" />
                    </div>

                    <!-- Email -->
                    <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                            Email
                        </label>
                        <h:inputText id="email"
                                     value="#{restaurantsBean.newRestaurant.email}"
                                     styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                     pass:placeholder="contact@example.com" />
                        <h:message for="email"
                                   styleClass="mt-1 text-xs text-red-500" />
                    </div>

                </div>

                <!-- CONTACT -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                    <!-- Phone -->
                    <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                            Phone
                        </label>
                        <h:inputText id="phone"
                                     value="#{restaurantsBean.newRestaurant.phone}"
                                     styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                     pass:placeholder="0987 654 321" />
                        <h:message for="phone"
                                   styleClass="mt-1 text-xs text-red-500" />
                    </div>

                    <!-- Contact Person -->
                    <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                        <label for="contact" class="block text-sm font-medium text-gray-700 mb-2">
                            Contact Person
                        </label>
                        <h:inputText id="contact"
                                     value="#{restaurantsBean.newRestaurant.contactPerson}"
                                     styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                     pass:placeholder="Manager name" />
                        <h:message for="contact"
                                   styleClass="mt-1 text-xs text-red-500" />
                    </div>

                </div>

                <!-- LOCATION: CITY + AREA -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                    <!-- City -->
                    <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
                            City <span class="text-red-500">*</span>
                        </label>
                        <h:selectOneMenu id="city"
                                         value="#{restaurantsBean.newCityId}"
                                         styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                         focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <f:selectItem itemValue="#{null}" itemLabel="-- Select city --" noSelectionOption="true" />
                            <f:selectItems value="#{restaurantsBean.cityList}"
                                           var="c"
                                           itemValue="#{c.cityId}"
                                           itemLabel="#{c.name}" />
                            <f:ajax listener="#{restaurantsBean.onNewCityChange}" render="area" />
                        </h:selectOneMenu>
                        <h:message for="city"
                                   styleClass="mt-1 text-xs text-red-500" />
                    </div>

                    <!-- Area -->
                    <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                        <label for="area" class="block text-sm font-medium text-gray-700 mb-2">
                            Area <span class="text-red-500">*</span>
                        </label>
                        <h:selectOneMenu id="area"
                                         value="#{restaurantsBean.newAreaId}"
                                         styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                         focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                            <f:selectItem itemValue="#{null}" itemLabel="-- Select area --" noSelectionOption="true" />
                            <f:selectItems value="#{restaurantsBean.areaOptionsForNew}"
                                           var="a"
                                           itemValue="#{a.areaId}"
                                           itemLabel="#{a.name}" />
                        </h:selectOneMenu>
                        <h:message for="area"
                                   styleClass="mt-1 text-xs text-red-500" />
                    </div>

                </div>

                <!-- ADDRESS -->
                <div class="rounded-xl border border-gray-200 px-3 py-3 bg-gray-50/60">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                        Address <span class="text-red-500">*</span>
                    </label>
                    <h:inputTextarea id="address"
                                     value="#{restaurantsBean.newRestaurant.address}"
                                     rows="2"
                                     styleClass="w-full rounded-lg border border-gray-300 text-sm px-3 py-2
                                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                     pass:placeholder="Full address" />
                    <h:message for="address"
                               styleClass="mt-1 text-xs text-red-500" />
                </div>

                <!-- ACTION BUTTONS -->
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button"
                            class="px-4 py-2 rounded-xl bg-gray-100 text-gray-700 text-sm hover:bg-gray-200"
                            onclick="document.getElementById('addRestaurantModal').close()">
                        Cancel
                    </button>

                    <h:commandButton value="Create"
                                     action="#{restaurantsBean.createRestaurant}"
                                     styleClass="px-5 py-2 rounded-xl bg-blue-600 text-white text-sm hover:bg-blue-700">
                        <f:ajax execute="@form"
                                render=":restaurantMainForm :addRestaurantForm" />
                    </h:commandButton>
                </div>

            </h:form>
        </dialog>

        <!-- SUCCESS POPUP -->
        <dialog id="successRestaurantModal"
                class="rounded-2xl shadow-xl w-full max-w-sm">
            <div class="p-6 text-center space-y-4">
                <h2 class="text-lg font-semibold text-gray-900">
                    Restaurant created successfully
                </h2>
                <p class="text-sm text-gray-500">
                    The restaurant has been added to the system.
                </p>
                <button type="button"
                        class="mt-2 px-4 py-2 rounded-xl bg-blue-600 text-white text-sm hover:bg-blue-700"
                        onclick="document.getElementById('successRestaurantModal').close()">
                    OK
                </button>
            </div>
        </dialog>

    </ui:define>
</ui:composition>
