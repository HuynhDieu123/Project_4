<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:f="jakarta.faces.core"
                template="/Restaurant/layout-manager.xhtml">

    <!-- TITLE -->
    <ui:define name="title">
        FeastLink - #{menuItemFormBean.editMode ? 'Edit Menu Item' : 'New Menu Item'}
    </ui:define>

    <!-- TOP BAR LEFT -->
    <ui:define name="header">
        <div class="flex flex-col">
            <h1 class="text-2xl font-bold text-text-main-light">
                Menu &amp; Packages
            </h1>
            <p class="text-sm text-text-secondary-light">
                #{menuItemFormBean.editMode
                  ? 'Update an existing menu item.'
                  : 'Add a new menu item to your restaurant.'}
            </p>
        </div>
    </ui:define>

    <!-- MAIN CONTENT -->
    <ui:define name="content">

        <!-- IMPORTANT: enctype for upload -->
        <h:form id="newItemForm" styleClass="max-w-4xl" enctype="multipart/form-data">

            <!-- Global messages -->
            <h:messages globalOnly="true"
                        styleClass="mb-4 rounded-xl border border-border-light bg-white px-4 py-3 text-sm text-text-main-light shadow-subtle"
                        layout="list" />

            <div class="bg-card-light rounded-2xl shadow-subtle p-8 space-y-6">

                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-text-main-light">
                            #{menuItemFormBean.editMode ? 'Edit Menu Item' : 'New Menu Item'}
                        </h2>
                        <p class="text-sm text-text-secondary-light mt-1">
                            #{menuItemFormBean.editMode
                              ? 'Change the details of your menu item.'
                              : 'Enter details for the new dish you want to offer.'}
                        </p>
                    </div>
                </div>

                <!-- Name + Price -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Name -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-text-main-light">
                            Name <span class="text-red-500">*</span>
                        </label>
                        <h:inputText id="name"
                                     value="#{menuItemFormBean.newItem.name}"
                                     required="true"
                                     requiredMessage="Name is required."
                                     styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60" />
                        <h:message for="name" styleClass="text-xs text-error-red mt-1 block" />
                    </div>

                    <!-- Price per person -->
                    <div>
                        <label for="price" class="block text-sm font-medium text-text-main-light">
                            Price per person ($) <span class="text-red-500">*</span>
                        </label>
                        <h:inputText id="price"
                                     value="#{menuItemFormBean.newItem.pricePerPerson}"
                                     required="true"
                                     requiredMessage="Price is required."
                                     styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                            <f:convertNumber maxFractionDigits="2" />
                        </h:inputText>
                        <h:message for="price" styleClass="text-xs text-error-red mt-1 block" />
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-text-main-light">
                        Description
                    </label>
                    <h:inputTextarea id="description"
                                     value="#{menuItemFormBean.newItem.description}"
                                     rows="3"
                                     styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60" />
                </div>

                <!-- Cuisine + Category -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="cuisine" class="block text-sm font-medium text-text-main-light">
                            Cuisine
                        </label>
                        <h:selectOneMenu id="cuisine"
                                         value="#{menuItemFormBean.cuisineId}"
                                         styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                            <f:selectItem itemLabel="-- Select cuisine --"
                                          itemValue="#{null}"
                                          noSelectionOption="true" />
                            <f:selectItems value="#{menuItemFormBean.cuisines}"
                                           var="c"
                                           itemValue="#{c.cuisineId}"
                                           itemLabel="#{c.name}" />
                        </h:selectOneMenu>
                    </div>

                    <div>
                        <label for="category" class="block text-sm font-medium text-text-main-light">
                            Category
                        </label>
                        <h:selectOneMenu id="category"
                                         value="#{menuItemFormBean.categoryId}"
                                         styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                            <f:selectItem itemLabel="-- Select category --"
                                          itemValue="#{null}"
                                          noSelectionOption="true" />
                            <f:selectItems value="#{menuItemFormBean.categories}"
                                           var="cat"
                                           itemValue="#{cat.categoryId}"
                                           itemLabel="#{cat.name}" />
                        </h:selectOneMenu>
                    </div>
                </div>

                <!-- Vegetarian + Status -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center gap-3 mt-2">
                        <h:selectBooleanCheckbox id="veg"
                                                 value="#{menuItemFormBean.newItem.isVegetarian}"
                                                 styleClass="h-4 w-4 rounded border-border-light text-champagne-gold focus:ring-champagne-gold/60" />
                        <label for="veg" class="text-sm text-text-main-light">
                            Vegetarian option
                        </label>
                    </div>

                    <div>
                        <label for="status" class="block text-sm font-medium text-text-main-light">
                            Status
                        </label>
                        <h:selectOneMenu id="status"
                                         value="#{menuItemFormBean.newItem.status}"
                                         styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                            <f:selectItem itemLabel="Active" itemValue="ACTIVE" />
                            <f:selectItem itemLabel="Inactive" itemValue="INACTIVE" />
                        </h:selectOneMenu>
                    </div>
                </div>

                <!-- âœ… IMAGE UPLOAD + PREVIEW -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="itemImage" class="block text-sm font-medium text-text-main-light">
                            Menu item image (upload)
                        </label>

                        <h:inputFile id="itemImage"
                                     value="#{menuItemFormBean.imageFile}"
                                     styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                            <f:passThroughAttribute name="accept" value="image/*" />
                            <f:passThroughAttribute name="onchange" value="previewMenuItemImage(this)" />
                        </h:inputFile>

                        <p class="mt-1 text-[11px] text-text-secondary-light">
                            Allowed: PNG/JPG/WebP. Max 5MB. If you upload, the Image URL below will be overwritten.
                        </p>

                        <h:message for="itemImage" styleClass="text-xs text-error-red mt-1 block" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-text-main-light">
                            Preview
                        </label>

                        <div class="mt-1 rounded-xl border border-border-light bg-white p-3">
                            <!-- Client-side preview (when choosing a file) -->
                            <img id="menuImgPreview"
                                 class="hidden w-full max-h-56 object-cover rounded-lg border border-border-light"
                                 alt="preview" />

                            <!-- Current image from DB (edit mode) -->
                            <div id="menuCurrentImageBox"
                                 class="#{empty menuItemFormBean.currentImageUrl ? '' : ''}">
                                <ui:fragment rendered="#{not empty menuItemFormBean.currentImageUrl}">
                                    <img src="#{menuItemFormBean.currentImageUrl}"
                                         class="w-full max-h-56 object-cover rounded-lg border border-border-light"
                                         alt="current" />
                                    <p class="mt-2 text-[11px] text-text-secondary-light">
                                        Current image
                                    </p>
                                </ui:fragment>

                                <ui:fragment rendered="#{empty menuItemFormBean.currentImageUrl}">
                                    <div class="text-xs text-text-secondary-light">
                                        No image yet.
                                    </div>
                                </ui:fragment>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image URL (optional / auto after upload) -->
                <div>
                    <label for="imageUrl" class="block text-sm font-medium text-text-main-light">
                        Image URL (optional)
                    </label>
                    <h:inputText id="imageUrl"
                                 value="#{menuItemFormBean.newItem.imageUrl}"
                                 styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60" />
                </div>

                <!-- Buttons -->
                <div class="flex justify-end gap-3 pt-4">
                    <h:link outcome="/Restaurant/menu-packages"
                            styleClass="px-4 py-2 rounded-lg border border-border-light text-sm text-text-secondary-light hover:bg-background-soft">
                        Cancel
                    </h:link>

                    <h:commandButton value="#{menuItemFormBean.editMode ? 'Save Changes' : 'Save Item'}"
                                     action="#{menuItemFormBean.save}"
                                     styleClass="px-5 py-2 rounded-lg bg-cta-orange text-white text-sm font-semibold shadow-subtle hover:opacity-90" />
                </div>

            </div>

            <script>
                function previewMenuItemImage(input) {
                    const file = (input &amp;&amp; input.files) ? input.files[0] : null;

                    const preview = document.getElementById("menuImgPreview");
                    const currentBox = document.getElementById("menuCurrentImageBox");
                    if (!preview) return;

                    if (!file) {
                        preview.src = "";
                        preview.classList.add("hidden");
                        if (currentBox) currentBox.classList.remove("hidden");
                        return;
                    }

                    const url = URL.createObjectURL(file);
                    preview.src = url;
                    preview.classList.remove("hidden");
                    if (currentBox) currentBox.classList.add("hidden");

                    preview.onload = function () {
                        URL.revokeObjectURL(url);
                    };
                }
            </script>

        </h:form>

    </ui:define>
</ui:composition>
