<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="jakarta.faces.html"
    xmlns:f="jakarta.faces.core"
    xmlns:ui="jakarta.faces.facelets"
    xmlns:pass="jakarta.faces.passthrough"
    template="/Restaurant/layout-manager.xhtml">

    <ui:define name="title">FeastLink - Restaurant Profile</ui:define>

    <!-- ===== TOP BAR LEFT (giống figma) ===== -->
    <ui:define name="header">
        <div class="flex flex-col">
            <h1 class="text-2xl font-bold text-text-main-light">
                Restaurant Profile Management
            </h1>
            <p class="text-sm text-text-secondary-light">
                Manage your restaurant&apos;s information and policies.
            </p>
        </div>
    </ui:define>

    <ui:define name="content">

        <h:form id="eventTypesForm">

            <h:messages globalOnly="true"
                        styleClass="mb-4 text-sm text-red-600" />

            <!-- HEADER + STATS -->
            <h:panelGroup id="statsPanel">
                <div class="mb-8 flex items-start justify-between gap-6">
                    <div>
                        <h2 class="text-3xl font-bold text-[#020617] mb-2">
                            Manage Event Types
                        </h2>
                        <p class="text-[#4B5563]">
                            Define which event types are available during booking (wedding, gala, birthday, etc.).
                        </p>
                    </div>

                    <div class="flex gap-3">
                        <div class="px-5 py-3 rounded-xl border-2 border-[#D4AF37] bg-white">
                            <div class="text-xs text-[#4B5563] mb-1">Total Event Types</div>
                            <div class="text-2xl font-bold text-[#020617]">
                                #{eventTypesBean.totalCount}
                            </div>
                        </div>
                        <div class="px-5 py-3 rounded-xl border-2 border-[#D4AF37] bg-white">
                            <div class="text-xs text-[#4B5563] mb-1">Used In Bookings</div>
                            <div class="text-2xl font-bold text-[#22C55E]">
                                #{eventTypesBean.usedCount}
                            </div>
                        </div>
                        <div class="px-5 py-3 rounded-xl border-2 border-[#D4AF37] bg-white">
                            <div class="text-xs text-[#4B5563] mb-1">Not Used Yet</div>
                            <div class="text-2xl font-bold text-[#4B5563]">
                                #{eventTypesBean.unusedCount}
                            </div>
                        </div>
                    </div>
                </div>
            </h:panelGroup>

            <!-- TOOLBAR -->
            <div class="mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex-1 w-full max-w-md relative">
                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-[#4B5563]">
                        search
                    </span>
                    <h:inputText value="#{eventTypesBean.keyword}"
                                 styleClass="w-full pl-12 pr-4 py-3 rounded-xl border border-[#E5E7EB] bg-white text-[#111827] placeholder:text-[#4B5563] focus:outline-none focus:ring-2 focus:ring-[#D4AF37] focus:border-transparent"
                                 pass:placeholder="Search by event type name...">
                        <f:ajax event="keyup"
                                listener="#{eventTypesBean.applyFilter}"
                                render="eventTypesTable statsPanel paginationPanel"/>
                    </h:inputText>
                </div>

                <div class="flex items-center gap-3 w-full md:w-auto">
                    <h:commandButton value="Reset"
                                     action="#{eventTypesBean.resetFilter}"
                                     styleClass="px-4 py-3 rounded-xl border border-[#E5E7EB] bg-white text-[#4B5563] text-sm hover:bg-[#F9FAFB] transition-all">
                        <f:ajax render="eventTypesTable statsPanel paginationPanel"/>
                    </h:commandButton>

                    <h:commandLink action="#{eventTypesBean.openCreate}"
                                   styleClass="inline-flex items-center justify-center gap-2 
                                   px-6 py-3 rounded-full
                                   bg-gradient-to-r from-[#F97316] to-[#EAB308]
                                   text-white text-sm font-semibold
                                   shadow-subtle hover:shadow-lg
                                   transition-all duration-200"
                                   style="text-decoration:none;">
                        <f:ajax execute="@this"
                                render="@form"/>

                        <span class="text-lg leading-none">+</span>
                        <span>Add New Event Type</span>
                    </h:commandLink>





                </div>
            </div>

            <!-- TABLE -->
            <h:panelGroup id="eventTypesTable">
                <div class="bg-white rounded-2xl shadow-md border border-[#E5E7EB] overflow-hidden">
                    <div class="px-6 py-4 border-b border-[#E5E7EB] bg-[#F5F5F4]">
                        <h2 class="text-sm font-semibold text-[#111827]">Event Type List</h2>
                        <p class="text-xs text-[#4B5563]">
                            Used by customers and restaurant managers when selecting event type during booking.
                        </p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-[#F5F5F4] border-b border-[#E5E7EB]">
                                    <th class="text-left px-6 py-3 text-xs font-semibold text-[#4B5563] uppercase tracking-wider">
                                        Event Type Name
                                    </th>
                                    <th class="text-left px-6 py-3 text-xs font-semibold text-[#4B5563] uppercase tracking-wider">
                                        Used In
                                    </th>
                                    <th class="text-right px-6 py-3 text-xs font-semibold text-[#4B5563] uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <ui:repeat value="#{eventTypesBean.pageEventTypes}"
                                           var="t">
                                    <tr class="border-b border-[#E5E7EB] hover:bg-[#F9FAFB] hover:border-l-4 hover:border-l-[#D4AF37] transition-all duration-150">
                                        <td class="px-6 py-5">
                                            <span class="font-semibold text-[#111827] text-base">
                                                #{t.name}
                                            </span>
                                        </td>
                                        <td class="px-6 py-5">
                                            <span class="text-sm text-[#4B5563]">
                                                <ui:fragment rendered="#{eventTypesBean.usageCount(t) gt 0}">
                                                    Used in #{eventTypesBean.usageCount(t)} booking#{eventTypesBean.usageCount(t) ne 1 ? 's' : ''}
                                                </ui:fragment>
                                                <ui:fragment rendered="#{eventTypesBean.usageCount(t) le 0}">
                                                    Not used yet
                                                </ui:fragment>
                                            </span>
                                        </td>
                                        <td class="px-6 py-5">
                                            <div class="flex items-center justify-end gap-2">
                                                <!-- EDIT -->
                                                <h:commandLink action="#{eventTypesBean.openEdit(t)}"
                                                               title="Edit">
                                                    <!-- gọi openEdit(t) xong render lại modal -->
                                                    <f:ajax execute="@this" render="@form"/>

                                                    <span class="p-2 rounded-lg text-[#0B1120] hover:bg-[#D4AF37] hover:text-white transition-all duration-150 flex items-center justify-center">
                                                        <span class="material-symbols-outlined text-sm">edit</span>
                                                    </span>
                                                </h:commandLink>


                                                <!-- DELETE -->
                                                <h:commandLink action="#{eventTypesBean.prepareDelete(t)}"
                                                               title="Delete"
                                                               immediate="true">
                                                    <f:ajax execute="@this"
                                                            render="@form"/>
                                                    <span class="p-2 rounded-lg text-[#EF4444] hover:bg-[#EF4444] hover:text-white transition-all duration-150 flex items-center justify-center">
                                                        <span class="material-symbols-outlined text-sm">delete</span>
                                                    </span>
                                                </h:commandLink>

                                            </div>
                                        </td>
                                    </tr>
                                </ui:repeat>

                                <ui:fragment rendered="#{empty eventTypesBean.pageEventTypes}">
                                    <tr>
                                        <td colspan="3" class="px-6 py-8 text-center text-sm text-[#4B5563]">
                                            No event types found. Try changing filters or add a new event type.
                                        </td>
                                    </tr>
                                </ui:fragment>
                            </tbody>
                        </table>
                    </div>
                </div>
            </h:panelGroup>

            <!-- FOOTER / PAGINATION -->
            <h:panelGroup id="paginationPanel">
                <div class="px-6 py-4 mt-2 flex items-center justify-between bg-transparent">
                    <p class="text-sm text-[#4B5563]">
                        Showing #{eventTypesBean.pageEventTypes.size()} of #{eventTypesBean.filteredEventTypes.size()} event types –
                        Page #{eventTypesBean.currentPage} of #{eventTypesBean.totalPages}
                    </p>

                    <div class="flex items-center gap-2 text-sm text-[#4B5563]">
                        <!-- Previous -->
                        <h:commandLink action="#{eventTypesBean.prevPage}">
                            <f:ajax render="eventTypesTable paginationPanel"/>
                            <span class="px-3 py-1 rounded-lg border border-transparent hover:border-[#E5E7EB] flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">chevron_left</span>
                                Previous
                            </span>
                        </h:commandLink>

                        <!-- Current page (highlight) -->
                        <span class="px-3 py-1 rounded-lg border border-[#D4AF37] text-[#111827] font-semibold">
                            #{eventTypesBean.currentPage}
                        </span>

                        <!-- Next -->
                        <h:commandLink action="#{eventTypesBean.nextPage}">
                            <f:ajax render="eventTypesTable paginationPanel"/>
                            <span class="px-3 py-1 rounded-lg border border-transparent hover:border-[#E5E7EB] flex items-center gap-1">
                                Next
                                <span class="material-symbols-outlined text-sm">chevron_right</span>
                            </span>
                        </h:commandLink>
                    </div>
                </div>
            </h:panelGroup>

            <!-- MODAL ADD / EDIT -->
            <h:panelGroup id="modalPanel"
                          rendered="#{not empty eventTypesBean.editingEventType}"
                          layout="block">

                <div class="fixed inset-0 bg-black bg-opacity-50 z-40"></div>

                <div class="fixed inset-y-0 right-0 w-full max-w-2xl bg-white shadow-2xl z-50 overflow-y-auto">
                    <div class="sticky top-0 bg-gradient-to-r from-[#020617] to-[#0B1120] px-8 py-6 flex items-center justify-between border-b-4 border-[#D4AF37]">
                        <div>
                            <h2 class="text-2xl font-bold text-white">
                                #{eventTypesBean.editingEventType.eventTypeId == null 
                                  ? 'Add New Event Type' 
                                  : 'Edit Event Type'}
                            </h2>
                            <p class="text-[#E6C77F] text-sm mt-1">
                                #{eventTypesBean.editingEventType.eventTypeId == null
                                  ? 'Create a new event type for the booking flow.'
                                  : 'Update event type name.'}
                            </p>
                        </div>
                        <h:commandLink action="#{eventTypesBean.cancelEdit}"
                                       immediate="true">
                            <f:ajax execute="@this"
                                    render="@form"/>
                            <span class="p-2 rounded-lg text-white hover:bg-white hover:bg-opacity-10 transition-all">
                                <span class="material-symbols-outlined">close</span>
                            </span>
                        </h:commandLink>

                    </div>



                    <!-- FORM NỘI DUNG -->
                    <div class="p-8 space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-[#111827] mb-2">
                                Event Type Name *
                            </label>
                            <h:inputText id="nameInput"
                                         value="#{eventTypesBean.editingEventType.name}"
                                         required="true"
                                         requiredMessage="Event type name is required"
                                         styleClass="w-full px-4 py-3 rounded-xl border border-[#E5E7EB] bg-white 
                                         text-[#111827] placeholder:text-[#4B5563] 
                                         focus:outline-none focus:ring-2 focus:ring-[#D4AF37] 
                                         focus:border-transparent" />
                            <h:message for="nameInput"
                                       styleClass="mt-1 text-xs text-red-600"/>

                        </div>
                    </div>

                    <!-- FOOTER BUTTONS -->
                    <div class="mt-8 pt-6 border-t border-[#E5E7EB] flex gap-4 px-8 pb-8">
                        <!-- Cancel -->
                        <h:commandLink action="#{eventTypesBean.cancelEdit}"
                                       styleClass="flex-1"
                                       immediate="true">
                            <f:ajax execute="@this"
                                    render="@form"/>
                            <div class="w-full text-center px-6 py-3 rounded-xl border-2 border-[#E5E7EB] 
                                 text-[#111827] font-semibold hover:bg-[#F9FAFB] transition-all">
                                Cancel
                            </div>
                        </h:commandLink>


                        <!-- Save (Create / Update) -->
                        <h:commandLink action="#{eventTypesBean.save}"
                                       styleClass="flex-1">
                            <!-- RẤT QUAN TRỌNG: submit form để lưu -->
                            <f:ajax execute="@form"
                                    render="@form"/>

                            <div class="w-full text-center px-6 py-3 rounded-xl 
                                 bg-gradient-to-r from-[#F97316] to-[#EAB308] 
                                 text-white font-semibold hover:shadow-lg transition-all duration-200">
                                #{eventTypesBean.editingEventType.eventTypeId == null 
                                  ? 'Save Event Type' 
                                  : 'Update Event Type'}
                            </div>
                        </h:commandLink>

                    </div>
                </div>
            </h:panelGroup>


            <!-- DELETE DIALOG -->
            <h:panelGroup id="deleteDialog"
                          rendered="#{not empty eventTypesBean.deleteTarget}">
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
                        <div class="p-6">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-12 h-12 rounded-full bg-[#EF4444] bg-opacity-10 flex items-center justify-center flex-shrink-0">
                                    <span class="material-symbols-outlined text-[#EF4444]">warning</span>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-[#111827]">Delete This Event Type?</h3>
                                </div>
                            </div>

                            <p class="text-[#4B5563] mb-2">
                                Are you sure you want to delete
                                <span class="font-semibold text-[#111827]">
                                    "#{eventTypesBean.deleteTarget.name}"
                                </span>?
                            </p>
                            <p class="text-[#4B5563] text-sm">
                                This event type will no longer appear in booking forms. This action cannot be undone.
                            </p>

                            <ui:fragment rendered="#{eventTypesBean.deleteTargetUsageCount gt 0}">
                                <div class="mt-4 p-4 bg-[#F97316] bg-opacity-10 border border-[#F97316] border-opacity-30 rounded-xl">
                                    <p class="text-sm text-[#F97316] font-medium">
                                        Warning: This event type is currently used in
                                        #{eventTypesBean.deleteTargetUsageCount}
                                        booking#{eventTypesBean.deleteTargetUsageCount ne 1 ? 's' : ''}.
                                    </p>
                                </div>
                            </ui:fragment>
                        </div>

                        <div class="bg-[#F9FAFB] px-6 py-4 flex gap-3">
                            <h:commandLink action="#{eventTypesBean.cancelDelete}"
                                           styleClass="flex-1"
                                           immediate="true">
                                <f:ajax execute="@this"
                                        render="@form"/>
                                <div class="w-full text-center px-6 py-3 rounded-xl border-2 border-[#E5E7EB] bg-white text-[#111827] font-semibold hover:bg-[#F5F5F4] transition-all">
                                    Cancel
                                </div>
                            </h:commandLink>



                            <h:commandLink action="#{eventTypesBean.confirmDelete}"
                                           styleClass="flex-1"
                                           immediate="true">
                                <f:ajax execute="@this"
                                        render="@form"/>
                                <div class="w-full text-center px-6 py-3 rounded-xl bg-[#EF4444] text-white font-semibold hover:bg-[#DC2626] hover:shadow-lg transition-all">
                                    Delete Event Type
                                </div>
                            </h:commandLink>


                        </div>
                    </div>
                </div>
            </h:panelGroup>

        </h:form>

    </ui:define>
</ui:composition>
