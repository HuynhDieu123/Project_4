<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:ui="jakarta.faces.facelets"
                xmlns:f="jakarta.faces.core"
                template="/Restaurant/layout-manager.xhtml">

    <!-- TITLE -->
    <ui:define name="title">
        FeastLink - #{menuComboFormBean.editMode ? 'Edit Package' : 'New Package'}
    </ui:define>

    <!-- HEADER -->
    <ui:define name="header">
        <div class="flex flex-col">
            <h1 class="text-2xl font-bold text-text-main-light">
                Menu &amp; Packages
            </h1>
            <p class="text-sm text-text-secondary-light">
                #{menuComboFormBean.editMode
                  ? 'Update an existing catering package.'
                  : 'Create a new catering package using your individual menu items.'}
            </p>
        </div>
    </ui:define>

    <!-- CONTENT -->
    <ui:define name="content">
        <h:form id="comboForm" styleClass="max-w-4xl">

            <div class="bg-card-light rounded-2xl shadow-subtle p-8 space-y-6">

                <!-- Heading -->
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-text-main-light">
                            #{menuComboFormBean.editMode ? 'Edit Catering Package' : 'New Catering Package'}
                        </h2>
                        <p class="text-sm text-text-secondary-light mt-1">
                            Select multiple dishes to bundle them into one package.
                        </p>
                    </div>
                </div>

                <!-- Name + Min guests -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-text-main-light">
                            Package name <span class="text-red-500">*</span>
                        </label>
                        <h:inputText id="name"
                                     value="#{menuComboFormBean.combo.name}"
                                     required="true"
                                     requiredMessage="Package name is required."
                                     styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60" />
                        <h:message for="name" styleClass="text-xs text-error-red mt-1" />
                    </div>

                    <div>
                        <label for="minGuests" class="block text-sm font-medium text-text-main-light">
                            Minimum guests
                        </label>
                        <h:inputText id="minGuests"
                                     value="#{menuComboFormBean.combo.minGuests}"
                                     styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                            <f:convertNumber integerOnly="true" />
                        </h:inputText>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-text-main-light">
                        Description
                    </label>
                    <h:inputTextarea id="description"
                                     value="#{menuComboFormBean.combo.description}"
                                     rows="3"
                                     styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60" />
                </div>

                <!-- Status + Price -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="status" class="block text-sm font-medium text-text-main-light">
                            Status
                        </label>
                        <h:selectOneMenu id="status"
                                         value="#{menuComboFormBean.combo.status}"
                                         styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                            <f:selectItem itemLabel="Active" itemValue="ACTIVE" />
                            <f:selectItem itemLabel="Inactive" itemValue="INACTIVE" />
                        </h:selectOneMenu>
                    </div>

                    <div>
                        <label for="priceTotal" class="block text-sm font-medium text-text-main-light">
                            Package price ($)
                        </label>
                        <h:inputText id="priceTotal"
                                     value="#{menuComboFormBean.combo.priceTotal}"
                                     styleClass="mt-1 block w-full rounded-lg border border-border-light bg-white px-3 py-2 text-sm text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                            <f:convertNumber maxFractionDigits="2" />
                        </h:inputText>
                        <p class="text-xs text-text-secondary-light mt-1">
                            You can calculate this manually based on the selected items.
                        </p>
                    </div>
                </div>

                <!-- Select items for this package -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-text-main-light mb-1">
                        Included dishes
                    </label>
                    <p class="text-xs text-text-secondary-light mb-3">
                        Search and filter your menu items, then select which dishes are included in this package.
                    </p>

                    <div class="bg-card-light rounded-2xl border border-border-light p-4 space-y-3">

                        <!-- FILTER BAR: search trên, filters dưới -->
                        <div class="space-y-3">

                            <!-- Search (full width trên cùng) -->
                            <div class="relative w-full">
                                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary-light text-sm">
                                    search
                                </span>
                                <h:inputText id="search"
                                             value="#{menuComboFormBean.searchKeyword}"
                                             styleClass="w-full pl-9 pr-3 py-2 rounded-lg border border-border-light bg-white text-xs text-text-main-light placeholder:text-text-secondary-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                                    <f:passThroughAttribute name="placeholder" value="Search by name or description..." />
                                    <f:ajax event="keyup" execute="@this" render="itemsListPanel" />
                                </h:inputText>
                            </div>

                            <!-- 3 dropdown filter ở dưới -->
                            <div class="flex flex-wrap gap-3">

                                <!-- Cuisine filter -->
                                <div class="min-w-[160px]">
                                    <label class="block text-[11px] font-medium text-text-secondary-light mb-1">
                                        Cuisine
                                    </label>
                                    <h:selectOneMenu id="cuisineFilter"
                                                     value="#{menuComboFormBean.filterCuisineId}"
                                                     styleClass="w-full rounded-lg border border-border-light bg-white px-3 py-1.5 text-xs text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                                        <f:selectItem itemLabel="All cuisines" itemValue="" noSelectionOption="true" />
                                        <f:selectItems value="#{menuComboFormBean.cuisineFilters}"
                                                       var="c"
                                                       itemValue="#{c.cuisineId}"
                                                       itemLabel="#{c.name}" />
                                        <f:ajax execute="@this" render="itemsListPanel" />
                                    </h:selectOneMenu>
                                </div>

                                <!-- Category filter -->
                                <div class="min-w-[160px]">
                                    <label class="block text-[11px] font-medium text-text-secondary-light mb-1">
                                        Category
                                    </label>
                                    <h:selectOneMenu id="categoryFilter"
                                                     value="#{menuComboFormBean.filterCategoryId}"
                                                     styleClass="w-full rounded-lg border border-border-light bg-white px-3 py-1.5 text-xs text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                                        <f:selectItem itemLabel="All categories" itemValue="" noSelectionOption="true" />
                                        <f:selectItems value="#{menuComboFormBean.categoryFilters}"
                                                       var="cat"
                                                       itemValue="#{cat.categoryId}"
                                                       itemLabel="#{cat.name}" />
                                        <f:ajax execute="@this" render="itemsListPanel" />
                                    </h:selectOneMenu>
                                </div>

                                <!-- Vegetarian filter -->
                                <div class="min-w-[160px]">
                                    <label class="block text-[11px] font-medium text-text-secondary-light mb-1">
                                        Dietary
                                    </label>
                                    <h:selectOneMenu id="vegFilter"
                                                     value="#{menuComboFormBean.filterVegetarian}"
                                                     styleClass="w-full rounded-lg border border-border-light bg-white px-3 py-1.5 text-xs text-text-main-light focus:outline-none focus:ring-2 focus:ring-champagne-gold/60">
                                        <f:selectItem itemLabel="All dishes" itemValue="ALL" />
                                        <f:selectItem itemLabel="Vegetarian only" itemValue="VEG" />
                                        <f:selectItem itemLabel="Non-vegetarian" itemValue="NON_VEG" />
                                        <f:ajax execute="@this" render="itemsListPanel" />
                                    </h:selectOneMenu>
                                </div>
                            </div>
                        </div>

                        <!-- LIST ITEMS: card style, checkbox + info + price -->
                        <h:panelGroup id="itemsListPanel" layout="block" styleClass="mt-3 space-y-2">

                            <ui:repeat value="#{menuComboFormBean.filteredItems}" var="mi">

                                <label class="flex items-center justify-between w-full rounded-2xl border border-border-light bg-white px-4 py-3 cursor-pointer hover:border-champagne-gold/70">

                                    <!-- checkbox + text -->
                                    <div class="flex items-center gap-3">
                                        <h:selectBooleanCheckbox value="#{menuComboFormBean.itemSelection[mi.menuItemId]}"
                                                                 styleClass="h-4 w-4 rounded border border-border-light" />

                                        <div>
                                            <p class="text-sm font-semibold text-text-main-light">
                                                #{mi.name}
                                            </p>
                                            <p class="text-xs text-text-secondary-light">
                                                <h:panelGroup rendered="#{mi.cuisineId != null}">
                                                    #{mi.cuisineId.name}
                                                </h:panelGroup>

                                                <h:panelGroup rendered="#{mi.isVegetarian}">
                                                    &#8226; Vegetarian
                                                </h:panelGroup>

                                                <h:panelGroup rendered="#{mi.categoryId != null}">
                                                    &#8226; #{mi.categoryId.name}
                                                </h:panelGroup>
                                            </p>
                                        </div>
                                    </div>

                                    <!-- price -->
                                    <p class="text-sm font-semibold text-champagne-gold">
                                        $
                                        <h:outputText value="#{mi.pricePerPerson}">
                                            <f:convertNumber groupingUsed="true" maxFractionDigits="0" />
                                        </h:outputText>
                                    </p>
                                </label>

                            </ui:repeat>

                            <h:panelGroup rendered="#{empty menuComboFormBean.filteredItems}">
                                <p class="text-xs text-text-secondary-light italic">
                                    No menu items match the current filters.
                                </p>
                            </h:panelGroup>

                        </h:panelGroup>

                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex justify-end gap-3 pt-4">
                    <h:link outcome="/Restaurant/menu-packages"
                            styleClass="px-4 py-2 rounded-lg border border-border-light text-sm text-text-secondary-light hover:bg-background-soft">
                        <f:param name="tab" value="packages" />
                        Cancel
                    </h:link>


                    <h:commandButton value="#{menuComboFormBean.editMode ? 'Save Changes' : 'Save Package'}"
                                     action="#{menuComboFormBean.save}"
                                     styleClass="px-5 py-2 rounded-lg bg-cta-orange text-white text-sm font-semibold shadow-subtle hover:opacity-90" />
                </div>

            </div>

        </h:form>
    </ui:define>

</ui:composition>
